---
title: "Pilot Data Analysis (Fall 2017)"
author: "Benjamin Gallo"
date: "Fall 2018"
output: html_document
---

###FOR ALL CODE INVOLVING UPLOADING / WRITING OF FILES. THE FILES ARE FOUND IN THE FOLDER OUTLINED IN THE 'read.csv' COMMAND. MODIFY THE CODE TO THE LOCATION OF THE DOCUMENT ON YOUR COMPUTER BEFOREHAND.###


```{r}
library(ggplot2)
library(reshape2)
library(ggrepel)
library(vegan)
library(ggmap)
library (entropart)
library(ggpubr)
RG_otus<-read.csv(file="~/USEARCH_RG/RG_otutable1.csv", header=TRUE, check.names = FALSE, row.names = 1)
```

St. Lawrence River Map (Fig 1):
```{r}
# SLR<- get_googlemap(center = c(lon = -76.09796, lat = 44.24746), zoom = 13, maptype = "terrain", color = "bw", style = 'feature:all|element:labels|visibility:off')
ggmap(SLR)
```

RGYBH - Rarefaction (Fig 2) - Code Contributions from Jessica Mizzi (https://github.com/jessicamizzi)

Note Rarefaction data is singleton!

```{r}
RGYBH_data<-read.table("~/USEARCH_RG_YBH/RGYBH_otutable.groups.rarefaction", header=TRUE)
RGYBHDataColumnsPrimary<-RGYBH_data[grepl("use", names(RGYBH_data))]
RGYBHnumSampled<-RGYBH_data[, c("numsampled")]
RGYBH_data<-cbind (RGYBHnumSampled, RGYBHDataColumnsPrimary)
RGYBH_long<-melt(RGYBH_data, id.vars="RGYBHnumSampled")

write.csv(RGYBH_long, "RGYBH_long.csv")

###Offloaded RGYBH_long###
###Manually  write in Species designations on .csv###

RGYBH_long<-read.csv(file = "~/USEARCH_RG_YBH/RGYBH_long.csv", header = TRUE, check.names = FALSE, row.names = 1)
```

```{r}
options (scipen = 100000000)
RGYBH_rarefaction<-ggplot(data=RGYBH_long, aes(x = RGYBHnumSampled, y = value, color=Species)) + geom_line (aes(group=variable), size=1.5) + scale_color_manual(values = c("brown", "blue")) + xlab("Number of Sequences") + ylab("OTUs (97% cutoff)")+ labs(title="Rarefaction Curves", subtitle="Species Comparison Between Round Goby and Yellow Bullhead") + theme_classic()
RGYBH_rarefaction<-RGYBH_rarefaction + theme(axis.text = element_text(size=14), axis.title = element_text(size=14))
```


RGYBH - NMDS (Fig 2) - Code contributions  by Geoffrey Zahn (http://geoffreyzahn.com/nmds-example/)

```{r}
RGYBH_otus<-read.csv(file="~/USEARCH_RG_YBH/RGYBH_otutable.csv", header=TRUE, check.names = FALSE, row.names = 1)

RGYBH_metadata<-read.csv(file = "~/USEARCH_RG_YBH/RGYBH_metadata.csv", header=TRUE, check.names = FALSE)

RGYBH_good_samples <- colnames(RGYBH_otus[(colSums(decostand(RGYBH_otus,"pa")) >= 1)])
RGYBH_otus <-RGYBH_otus[,RGYBH_good_samples]
RGYBH_t_otus<-as.data.frame(t(RGYBH_otus))
RGYBH_min_depth<-min(colSums(RGYBH_otus))
RGYBH_t_otus_rarefied<-as.data.frame(round(rrarefy(RGYBH_t_otus,RGYBH_min_depth)))
RGYBH_otus_dist = as.matrix(vegdist(RGYBH_t_otus_rarefied, "bray"))
RGYBH_NMDS = metaMDS(RGYBH_otus_dist)
RGYBH_MDS1 <-RGYBH_NMDS$points[,1]
RGYBH_MDS2<-RGYBH_NMDS$points[,2]
RGYBH_NMDS$stress

RGYBH_NMDS<-data.frame(RGYBH_MDS1=RGYBH_MDS1, RGYBH_MDS2=RGYBH_MDS2, Sample=RGYBH_metadata$Sample, Species=RGYBH_metadata$Species)
RGYBH_NMDS

RGYBH<-ggplot(RGYBH_NMDS, aes(x=RGYBH_MDS1,y=RGYBH_MDS2, col=Species)) + geom_point(size=1.5) + stat_ellipse(size=1.5) + labs(title = "NMDS Round Goby and Yellow Bullhead", subtitle = "Species Comparison - No Singletons") + scale_colour_manual(values = c("brown", "blue")) + xlab("MDS1") +geom_text(aes(label = "p-value 0.001"), x = 0.92, y = 0.71, size=4, color = "black") + geom_text(aes(label = "R^2 = 0.28"), x = 0.90, y = 0.63, size = 4, color = "black") + geom_text(aes(label = "Stress = 0.08"), x = 0.91, y = 0.55, size = 4, color = "black") + theme_classic() + ylab("MDS2") + geom_text_repel(aes(label = RGYBH_metadata$Sample))
RGYBH<-RGYBH + theme(axis.text = element_text(size=14), axis.title = element_text(size=14))

###Utilizing adonis to determine differences between groups###

adonis(formula = RGYBH_otus_dist ~ Species, data = RGYBH_metadata)
```

For singleton RGYBH NMDS:

```{r}

RGYBH_singleton_otus<-read.csv(file = "~/USEARCH_RG_YBH/RGYBH_singleton_otutable_UPDATE.csv", header = TRUE, check.names = FALSE, row.names = 1)
RGYBH_singleton_good_samples <- colnames(RGYBH_singleton_otus[(colSums(decostand(RGYBH_otus,"pa")) >= 1)])
RGYBH_singleton_otus <-RGYBH_singleton_otus[,RGYBH_singleton_good_samples]
RGYBH_t_otus_singleton<-as.data.frame(t(RGYBH_singleton_otus))
RGYBH_min_depth_singleton<-min(colSums(RGYBH_singleton_otus))
RGYBH_min_depth_singleton
RGYBH_t_otus_rarefied_singleton<-as.data.frame(round(rrarefy(RGYBH_t_otus_singleton,RGYBH_min_depth_singleton)))
RGYBH_t_otus_dist_singleton<-as.matrix(vegdist(RGYBH_t_otus_rarefied_singleton, "bray"))
RGYBH_NMDS_singleton = metaMDS(RGYBH_t_otus_dist_singleton)
RGYBH_MDS1 <-RGYBH_NMDS_singleton$points[,1]
RGYBH_MDS2<-RGYBH_NMDS_singleton$points[,2]
RGYBH_NMDS_singleton$stress
#0.07721164

RGYBH_NMDS_singleton<-data.frame(MDS1=RGYBH_MDS1, MDS2=RGYBH_MDS2, Sample=RGYBH_metadata$Sample, Species=RGYBH_metadata$Species)

RGYBH_singleton<-ggplot(RGYBH_NMDS_singleton, aes(x=RGYBH_MDS1,y=RGYBH_MDS2, col=Species)) + geom_point(size=2) + stat_ellipse(size=1.5) + labs(title = "NMDS Round Goby and Yellow Bullhead", subtitle = "Species Comparison - Singletons") + scale_colour_manual(values = c("brown", "blue")) + xlab("MDS1") +geom_text(aes(label = "p-value 0.002"), x = 0.92, y = 0.71, size=4, color = "black") + geom_text(aes(label = "R^2 = 0.28"), x = 0.90, y = 0.63, size = 4, color = "black") + geom_text(aes(label = "Stress = 0.08"), x = 0.91, y = 0.55, size = 4, color = "black") + theme_classic() + ylab("MDS2") + geom_text_repel(aes(label = RGYBH_metadata$Sample))
RGYBH_singleton<-RGYBH_singleton + theme(axis.text = element_text(size=14), axis.title = element_text(size=14))


adonis(formula = RGYBH_t_otus_dist_singleton ~ Species, data = RGYBH_metadata)
```

RGYBH Good's Coverage Calculation (Table 1):


First upload singleton data from USEARCH (See "Singleton RGYBH NMDS"):

```{r}
RGYBH_singleton_otus<-read.csv(file = "~/USEARCH_RG_YBH/RGYBH_singleton_otutable_UPDATE.csv", header = TRUE, check.names = FALSE, row.names = 1)
RGYBH_singleton_good_samples <- colnames(RGYBH_singleton_otus[(colSums(decostand(RGYBH_otus,"pa")) >= 1)])
RGYBH_singleton_otus <-RGYBH_singleton_otus[,RGYBH_singleton_good_samples]
RGYBH_t_otus_singleton<-as.data.frame(t(RGYBH_singleton_otus))
RGYBH_min_depth_singleton<-min(colSums(RGYBH_singleton_otus))
RGYBH_min_depth_singleton
RGYBH_t_otus_rarefied_singleton<-as.data.frame(round(rrarefy(RGYBH_t_otus_singleton,RGYBH_min_depth_singleton)))

```

Then compute:
```{r}
RGYBH_singleton_otus
RGYBH_otus_coverage<-data.frame(apply(RGYBH_t_otus_rarefied_singleton, 2, as.numeric))
apply(RGYBH_otus_coverage, 2, Coverage)
RGYBH_otus_coverage
```

Singleton RG Rarefaction (Fig 3A)
Note Rarefaction data is processed as singleton!

```{r}
RG_data<-read.table("~/USEARCH_RG/RG_otutableTESTgroups.rarefaction", header=TRUE)
RGDataColumnsPrimary<-RG_data[grepl("use", names(RG_data))]
RGnumSampled<-RG_data[, c("numsampled")]
RG_data<-cbind (RGnumSampled, RGDataColumnsPrimary)
RG_long<-melt(RG_data, id.vars="RGnumSampled")
write.csv(RG_long, "RG_long.csv")

###Offloaded RG_long --> add Location parameter column###

###Reload into R###
RG_long<-read.csv("~/USEARCH_RG/Microbiome_Research/Data_Files_Analysis/USEARCH_RG/RG_LONG_TEST.csv", header=TRUE)
head(RG_long)
```

```{r}
options(scipen=10000000)
RG_rarefaction<-ggplot(data=RG_long, aes(x=RGnumSampled, y=value, color=Location)) + geom_line(aes(group=variable), size=1.5) + xlab("Number of Sequences") + ylab("OTUs (97% cutoff)") + guides (color=guide_legend("Location")) + theme_classic() + labs(title="Rarefaction Curves", subtitle = "Habitat Comparsion Between Round Goby") + scale_color_manual(values = c("black", "cyan3"))
RG_rarefaction<-RG_rarefaction + theme(axis.text = element_text(size=14), axis.title = element_text(size=14))
```

RG - NMDS (Fig 3B)

```{r}
RG_otus<-read.csv("~/USEARCH_RG/Doubletons_RG_otutable_UPDATE.csv", header = TRUE, check.names = FALSE, row.names = 1)

RG_metadata<-read.csv(file = "~/USEARCH_RG/RG_metadata.csv", header=TRUE, check.names = FALSE)
RG_good_samples <- colnames(RG_otus[(colSums(decostand(RG_otus,"pa")) >= 1)])
RG_otus <-RG_otus[,RG_good_samples]
RG_t_otus<-as.data.frame(t(RG_otus))
RG_min_depth<-min(colSums(RG_otus))
RG_t_otus_rarefied<-as.data.frame(round(rrarefy(RG_t_otus,RG_min_depth)))
RG_otus_dist = as.matrix(vegdist(RG_t_otus_rarefied, "bray"))
RG_NMDS = metaMDS(RG_otus_dist)
RG_MDS1 <-RG_NMDS$points[,1]
RG_MDS2<-RG_NMDS$points[,2]
RG_NMDS$stress
RG_NMDS<-data.frame(RG_MDS1=RG_MDS1, RG_MDS2=RG_MDS2, Sample=RG_metadata$Sample, Location=RG_metadata$Location)

RG<-ggplot(RG_NMDS, aes(x=RG_MDS1,y=RG_MDS2, col=Location)) + geom_point(size=2) + stat_ellipse(size=1.5) + geom_text(aes(label = "Stress = 0.04"), x = 0.645, y = 0.65, size = 4, color = "black") + geom_text(aes(label = "p-value = 0.03"), x = 0.65, y = 0.85, size = 4, color = "black") + geom_text(aes(label = "R^2 = 0.17"), x = 0.61, y = 0.75, size = 4, color = "black") + labs(title = "NMDS Round Goby", subtitle = "Habitat Comparison - No Singletons") + xlab("MDS1") + ylab("MDS2") + theme_classic() +  geom_text_repel(aes(label = RG_metadata$Sample)) + scale_colour_manual(values=c("black", "cyan3"))
RG<-RG + theme(axis.text = element_text(size=14), axis.title = element_text(size=14))

RG

###Utilizing adonis to determine differences between groups###

adonis(formula = RG_otus_dist ~ Location, data = RG_metadata)
```

RG singleton NMDS:

```{r}
RG_singleton_otus<-read.csv(file = "~/USEARCH_RG/RG_singleton_otutable_UPDATE.csv", header = TRUE, check.names = FALSE, row.names = 1)

RG_good_sample_singleton_otu<-colnames(RG_singleton_otus[(colSums(decostand(RG_singleton_otus,"pa")) >= 1)])
RG_singleton_otus <-RG_singleton_otus[,RG_good_sample_singleton_otu]
RG_t_otus_singleton<-as.data.frame(t(RG_singleton_otus))
RG_min_depth_singleton<-min(colSums(RG_singleton_otus))
RG_t_otus_rarefied_singleton<-as.data.frame(round(rrarefy(RG_t_otus_singleton,RG_min_depth_singleton)))
RG_t_otus_dist_singleton<-as.matrix(vegdist(RG_t_otus_rarefied_singleton, "bray"))
RG_singleton_NMDS = metaMDS(RG_t_otus_dist_singleton)
RG_MDS1 <-RG_singleton_NMDS$points[,1]
RG_MDS2<-RG_singleton_NMDS$points[,2]
RG_singleton_NMDS$stress
#0.04258361


RG_singleton_NMDS<-data.frame(MDS1=RG_MDS1, MDS2=RG_MDS2, Sample=RG_metadata$Sample, Location=RG_metadata$Location)

RG_singleton<-ggplot(RG_singleton_NMDS, aes(x=RG_MDS1,y=RG_MDS2, col=Location)) + geom_point(size=2) + stat_ellipse(size=1.5) + geom_text(aes(label = "Stress = 0.04"), x = 0.645, y = 0.65, size = 4, color = "black") + geom_text(aes(label = "p-value = 0.03"), x = 0.65, y = 0.85, size = 4, color = "black") + geom_text(aes(label = "R^2 = 0.17"), x = 0.61, y = 0.75, size = 4, color = "black") + labs(title = "NMDS Round Goby", subtitle = "Habitat Comparison - Singletons") + xlab("MDS1") + ylab("MDS2") + theme_classic() +  geom_text_repel(aes(label = RG_metadata$Sample)) + scale_colour_manual(values=c("black", "cyan3"))
RG_singleton<-RG_singleton + theme(axis.text = element_text(size=14), axis.title = element_text(size=14))

adonis(formula = RG_t_otus_dist_singleton ~ Location, data = RG_metadata)
```

RG Good's Coverage Calculation (Table 2):

First upload singleton OTU data from USEARCH (See "RG Singleton NMDS"):

```{r}
RG_singleton_otus<-read.csv(file = "~/USEARCH_RG/RG_singleton_otutable_UPDATE.csv", header = TRUE, check.names = FALSE, row.names = 1)

RG_good_sample_singleton_otu<-colnames(RG_singleton_otus[(colSums(decostand(RG_singleton_otus,"pa")) >= 1)])
RG_singleton_otus <-RG_singleton_otus[,RG_good_sample_singleton_otu]
RG_t_otus_singleton<-as.data.frame(t(RG_singleton_otus))
RG_min_depth_singleton<-min(colSums(RG_singleton_otus))
RG_t_otus_rarefied_singleton<-as.data.frame(round(rrarefy(RG_t_otus_singleton,RG_min_depth_singleton)))

```


Then compute:
```{r}
RG_singleton_otus
RG_otus_coverage<-data.frame(apply(RG_t_otus_rarefied_singleton, 1, as.numeric))
apply(RG_otus_coverage, 2, Coverage)
RG_otus_coverage
```


Determining slope & richness from rarefaction curves (RGYBH group) (Table S1):

```{r}
###slope of singleton rarefaction curves at normalized sequencing depth###
RGYBH_otus_transformed<-t(RGYBH_singleton_otus)
rareslope(RGYBH_otus_transformed, 41249) * 1000

###you have to subtract one from minimum depth or else lowest sequence will give slope=0)###

###Calculating Richness at normalized & maximum sequencing depth / sample###
rarefy(RGYBH_t_otus_rarefied_singleton, min(rowSums(RGYBH_t_otus_rarefied_singleton)), se = FALSE, MARGIN = 1)

###Calculating total species richness###
specnumber(RGYBH_otus1_transformed)
```

Determining slope & richness from rarefaction curves (RG group) (Table S2):

```{r}
###slope of singleton rarefaction curves at normalized sequencing depth###
RG_otus_transformed<-t(RG_singleton_otus)
rareslope(RG_otus_transformed, 40971) * 1000

###you have to subtract one from minimum depth or else lowest sequence will give slope=0)###

###Calculating Richness at normalized & maximum sequencing depth / sample###
rarefy(RG_t_otus_rarefied_singleton, min(rowSums(RG_t_otus_rarefied_singleton)), se = FALSE, MARGIN = 1)

###Calculating total species richness###
specnumber(RG_otus_transformed)
```

Rarefying OTU tables for Top 3 OTU Identification

```{r}
###RGYBH###
RGYBH_doubleton_transformed<-t(RGYBH_otus)
RGYBH_otus_rarefied_doubleton<-rrarefy(RGYBH_doubleton_transformed, 41246)
RGYBH_otus_rarefied_singleton<-rrarefy(RGYBH_otus_transformed, 41250)
write.csv(RGYBH_otus_rarefied_doubleton, "RGYBH_norm_dub.csv")
write.csv(RGYBH_otus_rarefied_singleton, "RGYBH_norm_sing.csv")

###RG###
RG_doubleton_transformed<-t(RG_otus)
RG_otus_rarefied_singleton<-rrarefy(RG_otus_transformed, 40972)
RG_otus_rarefied_doubleton<-rrarefy(RG_doubleton_transformed, 40968)
write.csv(RG_otus_rarefied_singleton, "RG_norm_sing.csv")
write.csv(RG_otus_rarefied_doubleton, "RG_norm_dub")
```


Linking Figures together (e.g. Fig 2 A + B; Fig S1 A + B)

```{r}
RG_FINAL<-ggarrange(RG_rarefaction, RG_singleton, labels = c("A", "B"), common.legend = TRUE, legend = "right")
RGYBH_FINAL<-ggarrange(RGYBH_rarefaction, RGYBH_singleton, labels = c("A", "B"), common.legend = TRUE, legend = "right")
```

Linking Figures together (e.g. Fig S1 A + B; Fig S2 A + B)

```{r}
RG_FINAL<-ggarrange(RG, RG_singleton, labels = c("A", "B"), common.legend = TRUE, legend = "right")
RGYBH_FINAL<-ggarrange(RGYBH, RGYBH_singleton, labels = c("A", "B"), common.legend = TRUE, legend = "right")
```
